(function(c){function k(a,e){var g=a[0]-e[0],h=a[1]-e[1];return g*g+h*h}function m(a){for(var e=0,g=0,h=0,c=a.length-3;h<c;h+=2)e+=a[h],g+=a[h+1];a=2*(a.length-2);return[e/a<<0,g/a<<0]}function T(a){var e=a.length/2,g=new Y(e),h=0,c=e-1,l,f,B,la,k=[],y=[],m=[];for(g[h]=g[c]=1;c;){f=0;for(l=h+1;l<c;l++){B=a[2*l];var C=a[2*l+1],p=a[2*h],w=a[2*h+1],F=a[2*c],G=a[2*c+1],D=F-p,E=G-w,z=void 0;if(0!==D||0!==E)z=((B-p)*D+(C-w)*E)/(D*D+E*E),1<z?(p=F,w=G):0<z&&(p+=D*z,w+=E*z);D=B-p;E=C-w;B=D*D+E*E;B>f&&(la=
l,f=B)}2<f&&(g[la]=1,k.push(h),y.push(la),k.push(la),y.push(c));h=k.pop();c=y.pop()}for(l=0;l<e;l++)g[l]&&m.push(a[2*l],a[2*l+1]);return m}var Aa=Aa||Array,Y=Y||Array,f=Math,Ha=f.exp,Ia=f.log,Ja=f.sin,Ka=f.cos,va=f.tan,La=f.atan,$=f.min,wa=f.max,pa=c.document,C,Ba=function(a){var e,g,h;if(0===a.s)e=g=h=a.l;else{h=0.5>a.l?a.l*(1+a.s):a.l+a.s-a.l*a.s;var c=2*a.l-h;e=V(c,h,a.h+1/3);g=V(c,h,a.h);h=V(c,h,a.h-1/3)}return new C(255*e<<0,255*g<<0,255*h<<0,a.a)},V=function(a,e,g){0>g&&(g+=1);1<g&&(g-=1);return g<
1/6?a+6*(e-a)*g:0.5>g?e:g<2/3?a+6*(e-a)*(2/3-g):a},f=function(a,e,g,c){this.r=a;this.g=e;this.b=g;this.a=4>arguments.length?1:c},P=f.prototype;P.toString=function(){return"rgba("+[this.r<<0,this.g<<0,this.b<<0,this.a.toFixed(2)].join()+")"};P.adjustLightness=function(a){var e=C.toHSLA(this);e.l*=a;e.l=Math.min(1,Math.max(0,e.l));return Ba(e)};P.adjustAlpha=function(a){return new C(this.r,this.g,this.b,this.a*a)};f.parse=function(a){var e;a+="";if(~a.indexOf("#"))return e=a.match(/^#?(\w{2})(\w{2})(\w{2})(\w{2})?$/),
new C(parseInt(e[1],16),parseInt(e[2],16),parseInt(e[3],16),e[4]?parseInt(e[4],16)/255:1);if(e=a.match(/rgba?\((\d+)\D+(\d+)\D+(\d+)(\D+([\d.]+))?\)/))return new C(parseInt(e[1],10),parseInt(e[2],10),parseInt(e[3],10),e[4]?parseFloat(e[5],10):1);if(e=a.match(/hsla?\(([\d.]+)\D+([\d.]+)\D+([\d.]+)(\D+([\d.]+))?\)/))return Ba({h:parseInt(e[1],10)/360,s:parseFloat(e[2],10),l:parseFloat(e[3],10),a:e[4]?parseFloat(e[5],10):1})};f.toHSLA=function(a){var e=a.r/255,c=a.g/255,h=a.b/255,f=Math.max(e,c,h),l=
Math.min(e,c,h),k,y=(f+l)/2,m;if(f===l)k=l=0;else{m=f-l;l=0.5<y?m/(2-f-l):m/(f+l);switch(f){case e:k=(c-h)/m+(c<h?6:0);break;case c:k=(h-e)/m+2;break;case h:k=(e-c)/m+4}k/=6}return{h:k,s:l,l:y,a:a.a}};C=f;var Ca,f=Math,x=f.sin,J=f.cos,Ma=f.tan,Da=f.asin,Ea=f.atan2,Q=f.PI,n=180/Q,Na=357.5291/n,Oa=0.98560028/n,Pa=1.9148/n,Qa=0.02/n,Ra=3E-4/n,Sa=102.9372/n,Fa=23.45/n,Ta=280.16/n,Ua=360.9856235/n;Ca=function(a,e,c){c=-c/n;e/=n;a=a.valueOf()/864E5-0.5+2440588;var h=Na+Oa*(a-2451545),f=Pa*x(h)+Qa*x(2*h)+
Ra*x(3*h),f=h+Sa+f+Q,h=Da(x(f)*x(Fa)),f=Ea(x(f)*J(Fa),J(f));c=Ta+Ua*(a-2451545)-c-f;return{altitude:Da(x(e)*x(h)+J(e)*J(h)*J(c)),azimuth:Ea(x(c),J(c)*x(e)-Ma(h)*J(e))-Q/2}};var aa=Math.PI,Ga=aa/2,Va=aa/4,Wa=180/aa,Xa=256,xa=14,ba="latitude",ca="longitude",F=0,y=1,G=2,N=3,qa=4,R=5,L=6;c.OSMBuildings=function(a){function e(b,A){var j={};b/=da;A/=da;j[ba]=0>=A?90:1<=A?-90:Wa*(2*La(Ha(aa*(1-2*A)))-Ga);j[ca]=360*(1===b?1:(b%1+1)%1)-180;return j}function f(){if(P&&!(z<xa)){var b=e(D-U,E-oa),A=e(D+p+U,E+
w+oa);ra&&ra.abort();var j={w:b[ca],n:b[ba],e:A[ca],s:A[ba],z:z},b=P.replace(/\{ *([\w_]+) *\}/g,function(b,d){return j[d]}),d=h,a=new XMLHttpRequest;a.onreadystatechange=function(){4===a.readyState&&a.status&&!(200>a.status||299<a.status)&&a.responseText&&d(JSON.parse(a.responseText))};a.open("GET",b);a.send(null);ra=a}}function h(b){var A,j,d,a=[],c,e=c=0;W=xa;B(z);ra=null;if(b&&b.meta.z===z){d=b.meta;j=b.data;if(u&&s&&u.z===d.z){c=u.x-d.x;e=u.y-d.y;b=0;for(A=s.length;b<A;b++)a[b]=s[b][G][0]+c+
","+(s[b][G][1]+e)}u=d;s=[];b=0;for(A=j.length;b<A;b++)d=[],j[b][y]>ea||(c=T(j[b][G]),8>c.length||(d[G]=c,d[qa]=m(c),d[F]=$(j[b][F],ea),d[y]=j[b][y],c=d[G][0]+","+d[G][1],d[R]=!(a&&~a.indexOf(c)),d[N]=[],d[L]=[],s.push(d)));J()}}function n(b,A){var j,d,a=[],c,e,I,f,h,g,k,l,v=ya-z;c=0;for(e=b.length;c<e;c++)if(h=b[c],k=h[y]>>v,!(k>ea)){g=h[G];l=new Aa(g.length);I=0;for(f=g.length-1;I<f;I+=2)j=g[I+1],d=$(1,wa(0,0.5-Ia(va(Va+Ga*g[I]/180))/aa/2)),j=(j/360+0.5)*da<<0,d=d*da<<0,l[I]=j,l[I+1]=d;l=T(l);if(!(8>
l.length)){f=[];f[G]=l;f[qa]=m(l);f[F]=$(h[F]>>v,ea);f[y]=k;f[R]=A;f[N]=h[N];f[L]=[];for(I=0;3>I;I++)f[N][I]&&(f[L][I]=f[N][I].adjustAlpha(K)+"");a.push(f)}}return a}function l(b,A,j){void 0===j&&(j=[]);var d,a,c,e=b[0]?b:b.features,f,h,g,k,s,m=A?1:0,v=A?0:1;if(e){d=0;for(b=e.length;d<b;d++)l(e[d],A,j);return j}"Feature"===b.type&&(f=b.geometry,d=b.properties);"Polygon"===f.type&&(h=[f.coordinates]);"MultiPolygon"===f.type&&(h=f.coordinates);if(h){A=d.height;if(d.color||d.wallColor)k=C.parse(d.color||
d.wallColor);d.roofColor&&(s=C.parse(d.roofColor));d=0;for(b=h.length;d<b;d++){e=h[d][0];g=[];a=f=0;for(c=e.length;a<c;a++)g.push(e[a][m],e[a][v]),f+=A||e[a][2]||0;if(f){c=a=[];var t=G;for(var q=void 0,r=void 0,w=void 0,y=void 0,u=0,p=void 0,z=void 0,p=0,z=g.length-3;p<z;p+=2)q=g[p],r=g[p+1],w=g[p+2],y=g[p+3],u+=q*y-w*r;if("CW"!==(0<u/2?"CW":"CCW")){q=[];for(r=g.length-2;0<=r;r-=2)q.push(g[r],g[r+1]);g=q}c[t]=g;a[F]=f/e.length<<0;a[N]=[k||null,k?k.adjustLightness(0.8):null,s?s:k?k.adjustLightness(1.2):
S];j.push(a)}}}return j}function x(b,a){b?(fa=l(b,a),W=0,B(z),u={n:90,w:-180,s:-90,e:180,x:0,y:0,z:z},s=n(fa,!0),J()):(fa=null,Z())}function B(b){var a,j,d;z=b;da=Xa<<z;b=z;a=W;j=ya;b=$(wa(b,a),j);K=1-$(wa(0+0.4*((b-a)/(j-a)),0),0.4);Q=O.adjustAlpha(K)+"";ga=sa.adjustAlpha(K)+"";ha=S.adjustAlpha(K)+"";if(s){b=0;for(a=s.length;b<a;b++){d=s[b];d[L]=[];for(j=0;3>j;j++)d[N][j]&&(d[L][j]=d[N][j].adjustAlpha(K)+"")}}}function J(){clearInterval(za);M=0;ta.render();za=setInterval(function(){M+=0.1;if(1<M){clearInterval(za);
M=1;for(var b=0,a=s.length;b<a;b++)s[b][R]=0}ua.render();Z()},33)}function ma(){ua.render();ta.render();Z()}function Z(){H.clearRect(0,0,p,w);if(u&&s&&!(z<W||ia)){var b,a,j,d,c,e,f,h,g,l=D-u.x,m=E-u.y,C=ta.getMaxHeight(),n=[ja+l,ka+m],v,t,q,r,x,B;s.sort(function(b,a){return k(a[qa],n)/a[F]-k(b[qa],n)/b[F]});b=0;for(a=s.length;b<a;b++)if(c=s[b],!(c[F]<=C)){t=!1;e=c[G];v=[];j=0;for(d=e.length-1;j<d;j+=2)v[j]=h=e[j]-l,v[j+1]=g=e[j+1]-m,t||(t=0<h&&h<p&&0<g&&g<w);if(t){j=c[R]?c[F]*M:c[F];e=X/(X-j);c[y]&&
(j=c[R]?c[y]*M:c[y],f=X/(X-j));h=[];j=0;for(d=v.length-3;j<d;j+=2)g=v[j],q=v[j+1],t=v[j+2],r=v[j+3],x=na(g,q,e),B=na(t,r,e),c[y]&&(q=na(g,q,f),r=na(t,r,f),g=q.x,q=q.y,t=r.x,r=r.y),(t-g)*(x.y-q)>(x.x-g)*(r-q)&&(H.fillStyle=g<t&&q<r||g>t&&q>r?c[L][1]||ga:c[L][0]||Q,V([t,r,g,q,x.x,x.y,B.x,B.y])),h[j]=x.x,h[j+1]=x.y;H.fillStyle=c[L][2]||ha;H.strokeStyle=c[L][1]||ga;V(h,!0)}}}}function V(b,a){if(b.length){H.beginPath();H.moveTo(b[0],b[1]);for(var c=2,d=b.length;c<d;c+=2)H.lineTo(b[c],b[c+1]);H.closePath();
a&&H.stroke();H.fill()}}function na(b,a,c){return{x:(b-ja)*c+ja<<0,y:(a-ka)*c+ka<<0}}var p=0,w=0,U=0,oa=0,D=0,E=0,z,da,ra,H,P,O=new C(200,190,180),sa=O.adjustLightness(0.8),S=O.adjustLightness(1.2),Q=O+"",ga=sa+"",ha=S+"",fa,u,s,M=1,za,K=1,W=xa,ya=20,ea,ja,ka,X,ia,Y={container:null,items:[],init:function(b){var a=this.container=pa.createElement("DIV");a.style.pointerEvents="none";a.style.position="absolute";a.style.left=0;a.style.top=0;ua.init(this.add());ta.init(this.add());H=this.add();b.appendChild(a);
return a},add:function(){var b=pa.createElement("CANVAS");b.style.webkitTransform="translate3d(0,0,0)";b.style.imageRendering="optimizeSpeed";b.style.position="absolute";b.style.left=0;b.style.top=0;var a=b.getContext("2d");a.lineCap="round";a.lineJoin="round";a.lineWidth=1;try{a.mozImageSmoothingEnabled=!1}catch(c){}this.items.push(b);this.container.appendChild(b);return a},setSize:function(b,a){for(var c=this.items,d=0,e=c.length;d<e;d++)c[d].width=b,c[d].height=a}},ua={context:null,color:new C(0,
0,0),colorStr:this.color+"",date:null,alpha:1,length:0,directionX:0,directionY:0,init:function(b){this.context=b;this.setDate((new Date).setHours(10))},render:function(){var b=this.context,a,c,d,f;b.clearRect(0,0,p,w);if(u&&s&&!(z<W||ia))if(a=e(D+U,E+oa),a=Ca(this.date,a.latitude,a.longitude),!(0>=a.altitude)){c=1/va(a.altitude);d=0.4/c;this.directionX=Ka(a.azimuth)*c;this.directionY=Ja(a.azimuth)*c;this.color.a=d;f=this.color+"";var h,g,k,l,m,x=D-u.x,C=E-u.y,n,v,t,q,r,B,H=[];b.beginPath();a=0;for(c=
s.length;a<c;a++){g=s[a];v=!1;k=g[G];n=[];d=0;for(h=k.length-1;d<h;d+=2)n[d]=l=k[d]-x,n[d+1]=m=k[d+1]-C,v||(v=0<l&&l<p&&0<m&&m<w);if(v){k=g[R]?g[F]*M:g[F];g[y]&&(k=g[R]?g[y]*M:g[y]);l=null;d=0;for(h=n.length-3;d<h;d+=2)m=n[d],t=n[d+1],v=n[d+2],q=n[d+3],r=this.project(m,t,k),B=this.project(v,q,k),g[y]&&(t=this.project(m,t,k),q=this.project(v,q,k),m=t.x,t=t.y,v=q.x,q=q.y),(v-m)*(r.y-t)>(r.x-m)*(q-t)?(1===l&&b.lineTo(m,t),l=0,d||b.moveTo(m,t),b.lineTo(v,q)):(0===l&&b.lineTo(r.x,r.y),l=1,d||b.moveTo(r.x,
r.y),b.lineTo(B.x,B.y));b.closePath();H.push(n)}}b.fillStyle=f;b.fill();b.globalCompositeOperation="destination-out";b.beginPath();a=0;for(c=H.length;a<c;a++){f=H[a];b.moveTo(f[0],f[1]);d=2;for(h=f.length;d<h;d+=2)b.lineTo(f[d],f[d+1]);b.lineTo(f[0],f[1]);b.closePath()}b.fillStyle="#00ff00";b.fill();b.globalCompositeOperation="source-over"}},project:function(b,a,c){return{x:b+this.directionX*c,y:a+this.directionY*c}},setDate:function(b){this.date=b;this.render()}},ta={context:null,maxHeight:8,init:function(b){this.context=
b},render:function(){var b=this.context;b.clearRect(0,0,p,w);if(u&&s&&!(z<W||ia)){var a,c,d,e,f,g,h,k=D-u.x,l=E-u.y,m,n;b.beginPath();a=0;for(c=s.length;a<c;a++){d=s[a];n=!1;f=d[G];m=[];d=0;for(e=f.length-1;d<e;d+=2)m[d]=g=f[d]-k,m[d+1]=h=f[d+1]-l,n||(n=0<g&&g<p&&0<h&&h<w);if(n){d=0;for(e=m.length-3;d<e;d+=2)n=m[d],f=m[d+1],d?b.lineTo(n,f):b.moveTo(n,f);b.closePath()}}b.fillStyle=ha;b.strokeStyle=ga;b.stroke();b.fill()}},getMaxHeight:function(){return this.maxHeight}};this.setStyle=function(b){b=
b||{};if(b.color||b.wallColor)O=C.parse(b.color||b.wallColor),Q=O.adjustAlpha(K)+"",sa=O.adjustLightness(0.8),ga=sa.adjustAlpha(K)+"",S=O.adjustLightness(1.2),ha=S.adjustAlpha(K)+"";b.roofColor&&(S=C.parse(b.roofColor),ha=S.adjustAlpha(K)+"");ma();return this};this.geoJSON=function(b,a){if("object"===typeof b)x(b,!a);else{var e=pa.documentElement,d=pa.createElement("script");c.jsonpCallback=function(b){delete c.jsonpCallback;e.removeChild(d);x(b,!a)};e.insertBefore(d,e.lastChild).src=b.replace(/\{callback\}/,
"jsonpCallback")}return this};this.setCamOffset=function(b,a){ja=U+b;ka=w+a};this.setMaxZoom=function(a){ya=a};this.setDate=function(a){ua.setDate(a);return this};this.appendTo=function(a){return Y.init(a)};this.loadData=f;this.onMoveEnd=function(){var a=e(D,E),c=e(D+p,E+w);ma();u&&(a[ba]>u.n||a[ca]<u.w||c[ba]<u.s||c[ca]>u.e)&&f()};this.onZoomEnd=function(a){ia=!1;B(a.zoom);fa?(s=n(fa),ma()):(Z(),f())};this.onZoomStart=function(){ia=!0;ma()};this.setOrigin=function(a,c){D=a;E=c};this.setSize=function(a,
c){p=a;w=c;U=p/2<<0;oa=w/2<<0;ja=U;ka=w;X=p/1.5/va(45)<<0;Y.setSize(p,w);ea=X-50};this.setZoom=B;this.render=Z;P=a};c.OSMBuildings.VERSION="0.1.8a";c.OSMBuildings.ATTRIBUTION='&copy; <a href="http://osmbuildings.org">OSM Buildings</a>'})(this);
OpenLayers.Layer.Buildings=OpenLayers.Class(OpenLayers.Layer,{CLASS_NAME:"OpenLayers.Layer.Buildings",name:"OSM Buildings",attribution:OSMBuildings.ATTRIBUTION,isBaseLayer:!1,alwaysInRange:!0,dxSum:0,dySum:0,initialize:function(c){c=c||{};c.projection="EPSG:900913";OpenLayers.Layer.prototype.initialize(this.name,c)},setOrigin:function(){var c=this.map.getLonLatFromPixel(new OpenLayers.Pixel(0,0)),k=this.map.resolution,m=this.maxExtent,T=Math.round((c.lon-m.left)/k),c=Math.round((m.top-c.lat)/k);this.osmb.setOrigin(T,
c)},setMap:function(c){this.map||OpenLayers.Layer.prototype.setMap(c);this.osmb||(this.osmb=new OSMBuildings(this.options.url),this.container=this.osmb.appendTo(this.div));this.osmb.setSize(this.map.size.w,this.map.size.h);this.osmb.setZoom(this.map.zoom);this.setOrigin();this.osmb.loadData()},removeMap:function(c){this.container.parentNode.removeChild(this.container);OpenLayers.Layer.prototype.removeMap(c)},onMapResize:function(){OpenLayers.Layer.prototype.onMapResize();this.osmb.onResize({width:this.map.size.w,
height:this.map.size.h})},moveTo:function(c,k,m){c=OpenLayers.Layer.prototype.moveTo(c,k,m);if(!m){m=parseInt(this.map.layerContainerDiv.style.left,10);var T=parseInt(this.map.layerContainerDiv.style.top,10);this.div.style.left=-m+"px";this.div.style.top=-T+"px"}this.setOrigin();this.dySum=this.dxSum=0;this.osmb.setCamOffset(this.dxSum,this.dySum);if(k)this.osmb.onZoomEnd({zoom:this.map.zoom});else this.osmb.onMoveEnd();return c},moveByPx:function(c,k){this.dxSum+=c;this.dySum+=k;var m=OpenLayers.Layer.prototype.moveByPx(c,
k);this.osmb.setCamOffset(this.dxSum,this.dySum);this.osmb.render();return m},geoJSON:function(c,k){return this.osmb.geoJSON(c,k)},setStyle:function(c){return this.osmb.setStyle(c)},setDate:function(c){return this.osmb.setDate(c)}});
