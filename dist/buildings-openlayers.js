var OSMBuildings=function(Y){var E=Math.PI,fa=E/2,ka=E/4,la=180/E,ma=256,Z=14,$=400,ga=$-50,N="latitude",O="longitude",F=0,A=1,G=2,T=3,ha=ha||Array,na=Math.exp,oa=Math.log,pa=Math.tan,qa=Math.atan,aa=Math.min,ra=Math.max,ba=Y.document,k,B=function(b,d,c){0>c&&(c+=1);1<c&&(c-=1);return c<1/6?b+6*(d-b)*c:0.5>c?d:c<2/3?b+6*(d-b)*(2/3-c):b},u=function(b,d,c,g){this.r=b;this.g=d;this.b=c;this.a=4>arguments.length?1:g},H=u.prototype;H.toString=function(){return"rgba("+[this.r,this.g,this.b,this.a].join()+
")"};H.adjustLightness=function(b){var d=k.toHSLA(this);d.l+=b;d.l=Math.min(1,Math.max(0,d.l));var c,g;if(0===d.s)b=c=g=d.l;else{g=0.5>d.l?d.l*(1+d.s):d.l+d.s-d.l*d.s;var h=2*d.l-g,b=B(h,g,d.h+1/3);c=B(h,g,d.h);g=B(h,g,d.h-1/3)}return new k(~~(255*b),~~(255*c),~~(255*g),d.a)};H.adjustAlpha=function(b){return new k(this.r,this.g,this.b,this.a*b)};u.parse=function(b){if(~b.indexOf("#"))return b=b.match(/^#?(\w{2})(\w{2})(\w{2})(\w{2})?$/),new k(parseInt(b[1],16),parseInt(b[2],16),parseInt(b[3],16),
b[4]?parseInt(b[4],16)/255:1);if(b=b.match(/rgba?\((\d+)\D+(\d+)\D+(\d+)(\D+([\d.]+))?\)/))return new k(b[1],b[2],b[3],b[4]?b[5]:1)};u.toHSLA=function(b){var d=b.r/255,c=b.g/255,g=b.b/255,h=Math.max(d,c,g),p=Math.min(d,c,g),q,k=(h+p)/2,n;if(h===p)q=p=0;else{n=h-p;p=0.5<k?n/(2-h-p):n/(h+p);switch(h){case d:q=(c-g)/n+(c<g?6:0);break;case c:q=(g-d)/n+2;break;case g:q=(d-c)/n+4}q/=6}return{h:q,s:p,l:k,a:b.a}};k=u;return function(){function b(a,l){var j={},a=a/P,l=l/P;j[N]=0>=l?90:1<=l?-90:la*(2*qa(na(E*
(1-2*l)))-fa);j[O]=360*(1===a?1:(a%1+1)%1)-180;return j}function d(a,l){var j=aa(1,ra(0,0.5-oa(pa(ka+fa*a/180))/E/2));return{x:~~((l/360+0.5)*P),y:~~(j*P)}}function c(){if(ca&&!(y<Z)){var a=b(J-Q,K-da),l=b(J+I+Q,K+z+da);U&&U.abort();var j={w:a[O],n:a[N],e:l[O],s:l[N],z:y},a=ca.replace(/\{ *([\w_]+) *\}/g,function(a,l){return j[l]||""}),e=g,f=new XMLHttpRequest;f.onreadystatechange=function(){4===f.readyState&&f.status&&!(200>f.status||299<f.status)&&f.responseText&&e(JSON.parse(f.responseText))};
f.open("GET",a);f.send(null);U=f}}function g(a){var l,j,e,f=[],b=0,v=0;R=Z;n(y);U=null;if(a&&a.meta.z===y){e=a.meta;j=a.data;if(s&&i&&s.z===e.z){b=s.x-e.x;v=s.y-e.y;a=0;for(l=i.length;a<l;a++)f[a]=i[a][A][0]+b+","+(i[a][A][1]+v)}s=e;i=[];a=0;for(l=j.length;a<l;a++)i[a]=j[a],i[a][F]=aa(i[a][F],ga),e=i[a][A][0]+","+i[a][A][1],i[a][T]=!(f&&~f.indexOf(e));B()}}function h(a,l){var j=[],e,f,b,v,c,m,V,g,i=ia-y;e=0;for(f=a.length;e<f;e++){c=a[e];m=c[A];V=new ha(m.length);b=0;for(v=m.length-1;b<v;b+=2)g=d(m[b],
m[b+1]),V[b]=g.x,V[b+1]=g.y;j[e]=[];j[e][F]=aa(c[F]>>i,ga);j[e][A]=V;j[e][G]=c[G];j[e][T]=l}return j}function p(a,l,b){void 0===b&&(b=[]);var e,f,d,v=a[0]?a:a.features,c,m,g,i,r=l?1:0,s=l?0:1;if(v){e=0;for(a=v.length;e<a;e++)p(v[e],l,b);return b}"Feature"===a.type&&(f=a.geometry,e=a.properties);"Polygon"===f.type&&(c=[f.coordinates]);"MultiPolygon"===f.type&&(c=f.coordinates);if(c){l=e.height;v=k.parse(e.color||e.style.fillColor);e=0;for(a=c.length;e<a;e++){m=c[e][0];g=[];f=i=0;for(d=m.length;f<d;f++)g.push(m[f][r],
m[f][s]),i+=l||m[f][2]||0;if(i){f=[];f[F]=~~(i/m.length);m=f;i=A;for(var h=d=void 0,t=void 0,o=void 0,q=0,w=void 0,n=void 0,w=0,n=g.length-3;w<n;w+=2)d=g[w],h=g[w+1],t=g[w+2],o=g[w+3],q+=d*o-t*h;if("CW"!==(0<q/2?"CW":"CCW")){d=[];for(h=g.length-2;0<=h;h-=2)d.push(g[h],g[h+1]);g=d}m[i]=g;v&&(f[G]=[v,v.adjustLightness(0.2)]);b.push(f)}}}return b}function q(a,b){a?(S=p(a,b),R=0,n(y),s={n:90,w:-180,s:-90,e:180,x:0,y:0,z:y},i=h(S,!0),B()):(S=null,x())}function u(a,b){I=a;z=b;Q=~~(I/2);da=~~(z/2);C=Q;D=
z;o.width=I;o.height=z}function n(a){y=a;P=ma<<y;L=1-0.3*(y-R)/(ia-R)}function B(){M=0;clearInterval(ea);ea=setInterval(function(){M+=0.1;if(1<M){clearInterval(ea);M=1;for(var a=0,b=i.length;a<b;a++)i[a][T]=0}x()},33)}function x(){var a,b,j,e;r.clearRect(0,0,I,z);if(s&&i&&!(y<R||sa)){var f,d,c,g,m,h,o=J-s.x,q=K-s.y,n,k,t,p,u,w,x,B=W.adjustAlpha(L),E=ja.adjustAlpha(L);X&&(r.strokeStyle=ta.adjustAlpha(L)+"");f=0;for(d=i.length;f<d;f++){m=i[f];e=!1;a=m[A];n=[];c=0;for(g=a.length-1;c<g;c+=2)n[c]=b=a[c]-
o,n[c+1]=j=a[c+1]-q,e||(e=0<b&&b<I&&0<j&&j<z);if(e){r.fillStyle=(m[G]?m[G][0].adjustAlpha(L):B)+"";c=m[T]?m[F]*M:m[F];h=$/($-c);k=[];t=[];c=0;for(g=n.length-3;c<g;c+=2)p=n[c],u=n[c+1],w=n[c+2],x=n[c+3],j=~~((p-C)*h+C),e=~~((u-D)*h+D),a=~~((w-C)*h+C),b=~~((x-D)*h+D),(w-p)*(e-u)>(j-p)*(x-u)?(t.length||(t.unshift(u),t.unshift(p),t.push(j,e)),t.unshift(x),t.unshift(w),t.push(a,b)):(H(t),t=[]),k[c]=j,k[c+1]=e;H(t);r.fillStyle=(m[G]?m[G][1].adjustAlpha(L):E)+"";H(k,X)}}}}function H(a,b){if(a.length){r.beginPath();
r.moveTo(a[0],a[1]);for(var c=2,e=a.length;c<e;c+=2)r.lineTo(a[c],a[c+1]);r.closePath();b&&r.stroke();r.fill()}}var I=0,z=0,Q=0,da=0,J=0,K=0,y,P,U,o,r,ca,X,W=new k(200,190,180),ja=W.adjustLightness(0.2),ta=new k(145,140,135),S,s,i,L=1,M=1,ea,R=Z,ia=20,C,D,sa=!1;this.VERSION="0.1.5a";this.render=function(){x();return this};this.setStyle=function(a){a=a||{};X=void 0!==a.strokeRoofs?a.strokeRoofs:X;a.fillColor&&(W=k.parse(a.fillColor),ja=W.adjustLightness(0.2));x();return this};this.setData=function(a,
b){console.warn("OSMBuildings.loadData() is deprecated and will be removed soon.\nUse OSMBuildings.loadData({url|object}, isLatLon?) instead.");q(a,b);return this};this.loadData=function(a){ca=a;c();return this};this.geoJSON=function(a,b){if("object"===typeof a)q(a,!b);else{var c=ba.documentElement,e=ba.createElement("script");Y.jsonpCallback=function(a){delete Y.jsonpCallback;c.removeChild(e);q(a,!b)};c.insertBefore(e,c.lastChild).src=a.replace(/\{callback\}/,"jsonpCallback")}return this};OpenLayers.Layer.Buildings=
OpenLayers.Class(OpenLayers.Layer,{CLASS_NAME:"OpenLayers.Layer.Buildings",isBaseLayer:!1,alwaysInRange:!0,attribution:'Buildings &copy; <a href="http://osmbuildings.org">OSM Buildings</a>',initialize:function(a,b,c){OpenLayers.Layer.prototype.initialize.apply(this,[a,c]);this.b=b},updateOrigin:function(){var a=this.map.getLonLatFromPixel(new OpenLayers.Pixel(0,0)).transform(this.map.getProjectionObject(),new OpenLayers.Projection("EPSG:4326")),a=d(a.lat,a.lon),b=a.y;J=a.x;K=b},setMap:function(a){if(!this.map){OpenLayers.Layer.prototype.setMap.apply(this,
arguments);var b=this.div;o=ba.createElement("canvas");o.style.webkitTransform="translate3d(0,0,0)";o.style.position="absolute";o.style.pointerEvents="none";o.style.left=0;o.style.top=0;o.style.imageRendering="optimizeSpeed";b.appendChild(o);r=o.getContext("2d");r.lineCap="round";r.lineJoin="round";r.lineWidth=1;try{r.mozImageSmoothingEnabled=!1}catch(d){}b=this.map.getSize();u(b.w,b.h);n(this.map.getZoom());this.updateOrigin();c()}},removeMap:function(a){o.parentNode.removeChild(o);OpenLayers.Layer.prototype.removeMap.apply(this,
arguments)},onMapResize:function(){OpenLayers.Layer.prototype.onMapResize.apply(this,arguments);var a=this.map.getSize();u(a.w,a.h);x()},moveTo:function(a,d,g){var e=OpenLayers.Layer.prototype.moveTo.apply(this,arguments);if(!g){var f=parseInt(this.map.layerContainerDiv.style.left,10),f=-Math.round(f),k=parseInt(this.map.layerContainerDiv.style.top,10),k=-Math.round(k);this.div.style.left=f+"px";this.div.style.top=k+"px"}d&&(n(this.map.getZoom()),S&&(i=h(S)));this.updateOrigin();C=Q;D=z;x();f=b(J,
K);k=b(J+I,K+z);s&&(f[N]>s.n||f[O]<s.w||k[N]<s.s||k[O]>s.e)&&c();return e},moveByPx:function(a,b){var c=OpenLayers.Layer.prototype.moveByPx.apply(this,arguments);C+=a;D+=b;x();return c}});this.VERSION+="-openlayers";this.addTo=function(a){this.layer=new OpenLayers.Layer.Buildings("OSMBuildings",this);a.addLayer(this.layer);return this};arguments.length&&this.addTo(arguments[0])}}(this);
