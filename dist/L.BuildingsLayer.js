(function(a){function k(e,b){var n=e[0]-b[0],f=e[1]-b[1];return n*n+f*f}function Aa(e){for(var b=0,n=0,f=0,a=e.length-3;f<a;f+=2)b+=e[f],n+=e[f+1];e=2*(e.length-2);return[b/e<<0,n/e<<0]}function Ba(e){var b=e.length/2,n=new Z(b),a=0,j=b-1,p,g,J,ma,k=[],x=[],q=[];for(n[a]=n[j]=1;j;){g=0;for(p=a+1;p<j;p++){J=e[2*p];var F=e[2*p+1],A=e[2*a],z=e[2*a+1],G=e[2*j],w=e[2*j+1],D=G-A,E=w-z,C=void 0;if(0!==D||0!==E)C=((J-A)*D+(F-z)*E)/(D*D+E*E),1<C?(A=G,z=w):0<C&&(A+=D*C,z+=E*C);D=J-A;E=F-z;J=D*D+E*E;J>g&&(ma=
p,g=J)}2<g&&(n[ma]=1,k.push(a),x.push(ma),k.push(ma),x.push(j));a=k.pop();j=x.pop()}for(p=0;p<b;p++)n[p]&&q.push(e[2*p],e[2*p+1]);return q}var Ca=Ca||Array,Z=Z||Array,g=Math,Ja=g.exp,Ka=g.log,La=g.sin,Ma=g.cos,va=g.tan,Na=g.atan,aa=g.min,wa=g.max,pa=a.document,q,Da=function(e){var b,a,f;if(0===e.s)b=a=f=e.l;else{f=0.5>e.l?e.l*(1+e.s):e.l+e.s-e.l*e.s;var j=2*e.l-f;e.h/=360;b=W(j,f,e.h+1/3);a=W(j,f,e.h);f=W(j,f,e.h-1/3)}return new q(255*b<<0,255*a<<0,255*f<<0,e.a)},W=function(e,b,a){0>a&&(a+=1);1<a&&
(a-=1);return a<1/6?e+6*(b-e)*a:0.5>a?b:a<2/3?e+6*(b-e)*(2/3-a):e},g=function(e,a,n,f){this.r=e;this.g=a;this.b=n;this.a=4>arguments.length?1:f},R=g.prototype;R.toString=function(){return"rgba("+[this.r<<0,this.g<<0,this.b<<0,this.a.toFixed(2)].join()+")"};R.adjustLightness=function(a){var b=q.toHSLA(this);b.l*=a;b.l=Math.min(1,Math.max(0,b.l));return Da(b)};R.adjustAlpha=function(a){return new q(this.r,this.g,this.b,this.a*a)};g.parse=function(a){var b;a+="";if(~a.indexOf("#"))return b=a.match(/^#?(\w{2})(\w{2})(\w{2})(\w{2})?$/),
new q(parseInt(b[1],16),parseInt(b[2],16),parseInt(b[3],16),b[4]?parseInt(b[4],16)/255:1);if(b=a.match(/rgba?\((\d+)\D+(\d+)\D+(\d+)(\D+([\d.]+))?\)/))return new q(parseInt(b[1],10),parseInt(b[2],10),parseInt(b[3],10),b[4]?parseFloat(b[5]):1);if(b=a.match(/hsla?\(([\d.]+)\D+([\d.]+)\D+([\d.]+)(\D+([\d.]+))?\)/))return Da({h:parseInt(b[1],10),s:parseFloat(b[2]),l:parseFloat(b[3]),a:b[4]?parseFloat(b[5]):1})};g.toHSLA=function(a){var b=a.r/255,n=a.g/255,f=a.b/255,j=Math.max(b,n,f),g=Math.min(b,n,f),
k,x=(j+g)/2,q;if(j===g)k=g=0;else{q=j-g;g=0.5<x?q/(2-j-g):q/(j+g);switch(j){case b:k=(n-f)/q+(n<f?6:0);break;case n:k=(f-b)/q+2;break;case f:k=(b-n)/q+4}k/=6}return{h:360*k,s:g,l:x,a:a.a}};q=g;var Ea,g=Math,B=g.sin,I=g.cos,Oa=g.tan,Fa=g.asin,Ga=g.atan2,S=g.PI,w=180/S,Pa=357.5291/w,Qa=0.98560028/w,Ra=1.9148/w,Sa=0.02/w,Ta=3E-4/w,Ua=102.9372/w,Ha=23.45/w,Va=280.16/w,Wa=360.9856235/w;Ea=function(a,b,g){g=-g/w;b/=w;a=a.valueOf()/864E5-0.5+2440588;var f=Pa+Qa*(a-2451545),j=Ra*B(f)+Sa*B(2*f)+Ta*B(3*f),
j=f+Ua+j+S,f=Fa(B(j)*B(Ha)),j=Ga(B(j)*I(Ha),I(j));g=Va+Wa*(a-2451545)-g-j;return{altitude:Fa(B(b)*B(f)+I(b)*I(f)*I(g)),azimuth:Ga(B(g),I(g)*B(b)-Oa(f)*I(b))-S/2}};var ba=Math.PI,Ia=ba/2,Xa=ba/4,Ya=180/ba,Za=256,xa=14,ca="latitude",da="longitude",F=0,x=1,G=2,P=3,qa=4,T=5,N=6;a.OSMBuildings=function(e){function b(c,a){var h={};c/=ea;a/=ea;h[ca]=0>=a?90:1<=a?-90:Ya*(2*Na(Ja(ba*(1-2*a)))-Ia);h[da]=360*(1===c?1:(c%1+1)%1)-180;return h}function g(){if(R&&!(C<xa)){var c=b(D-V,E-oa),a=b(D+A+V,E+z+oa);ra&&
ra.abort();var h={w:c[da],n:c[ca],e:a[da],s:a[ca],z:C},c=R.replace(/\{ *([\w_]+) *\}/g,function(c,d){return h[d]}),d=f,H=new XMLHttpRequest;H.onreadystatechange=function(){4===H.readyState&&H.status&&!(200>H.status||299<H.status)&&H.responseText&&d(JSON.parse(H.responseText))};H.open("GET",c);H.send(null);ra=H}}function f(c){var a,h,d,H=[],b,e=b=0;X=xa;J(C);ra=null;if(c&&c.meta.z===C){d=c.meta;h=c.data;if(r&&m&&r.z===d.z){b=r.x-d.x;e=r.y-d.y;c=0;for(a=m.length;c<a;c++)H[c]=m[c][G][0]+b+","+(m[c][G][1]+
e)}r=d;m=[];c=0;for(a=h.length;c<a;c++)d=[],h[c][x]>fa||(b=Ba(h[c][G]),8>b.length||(d[G]=b,d[qa]=Aa(b),d[F]=aa(h[c][F],fa),d[x]=h[c][x],b=d[G][0]+","+d[G][1],d[T]=!(H&&~H.indexOf(b)),d[P]=[],d[N]=[],m.push(d)));B()}}function j(c,a){var h,d,b=[],e,g,v,l,f,j,k,m,y=ya-C;e=0;for(g=c.length;e<g;e++)if(f=c[e],k=f[x]>>y,!(k>fa)){j=f[G];m=new Ca(j.length);v=0;for(l=j.length-1;v<l;v+=2)h=j[v+1],d=aa(1,wa(0,0.5-Ka(va(Xa+Ia*j[v]/180))/ba/2)),h=(h/360+0.5)*ea<<0,d=d*ea<<0,m[v]=h,m[v+1]=d;m=Ba(m);if(!(8>m.length)){l=
[];l[G]=m;l[qa]=Aa(m);l[F]=aa(f[F]>>y,fa);l[x]=k;l[T]=a;l[P]=f[P];l[N]=[];for(v=0;3>v;v++)l[P][v]&&(l[N][v]=l[P][v].adjustAlpha(M)+"");b.push(l)}}return b}function p(c,a,h){void 0===h&&(h=[]);var d,b,e,g=c[0]?c:c.features,v,l,f,j,m,k=a?1:0,y=a?0:1;if(g){d=0;for(c=g.length;d<c;d++)p(g[d],a,h);return h}"Feature"===c.type&&(v=c.geometry,d=c.properties);"Polygon"===v.type&&(l=[v.coordinates]);"MultiPolygon"===v.type&&(l=v.coordinates);if(l){a=d.height;if(d.color||d.wallColor)j=q.parse(d.color||d.wallColor);
d.roofColor&&(m=q.parse(d.roofColor));d=0;for(c=l.length;d<c;d++){g=l[d][0];f=[];b=v=0;for(e=g.length;b<e;b++)f.push(g[b][k],g[b][y]),v+=a||g[b][2]||0;if(v){e=b=[];var u=G;for(var s=void 0,t=void 0,n=void 0,z=void 0,x=0,r=void 0,A=void 0,r=0,A=f.length-3;r<A;r+=2)s=f[r],t=f[r+1],n=f[r+2],z=f[r+3],x+=s*z-n*t;if("CW"!==(0<x/2?"CW":"CCW")){s=[];for(t=f.length-2;0<=t;t-=2)s.push(f[t],f[t+1]);f=s}e[u]=f;b[F]=v/g.length<<0;b[P]=[j||null,j?j.adjustLightness(0.8):null,m?m:j?j.adjustLightness(1.2):U];h.push(b)}}}return h}
function w(c,a){c?(ga=p(c,a),X=0,J(C),r={n:90,w:-180,s:-90,e:180,x:0,y:0,z:C},m=j(ga,!0),B()):(ga=null,$())}function J(c){var a,h,d;C=c;ea=Za<<C;c=C;a=X;h=ya;c=aa(wa(c,a),h);M=1-aa(wa(0+0.4*((c-a)/(h-a)),0),0.4);S=Q.adjustAlpha(M)+"";ha=sa.adjustAlpha(M)+"";ia=U.adjustAlpha(M)+"";if(m){c=0;for(a=m.length;c<a;c++){d=m[c];d[N]=[];for(h=0;3>h;h++)d[P][h]&&(d[N][h]=d[P][h].adjustAlpha(M)+"")}}}function B(){clearInterval(za);O=0;ta.render();za=setInterval(function(){O+=0.1;if(1<O){clearInterval(za);O=
1;for(var c=0,a=m.length;c<a;c++)m[c][T]=0}ua.render();$()},33)}function I(){ua.render();ta.render();$()}function $(){K.clearRect(0,0,A,z);if(r&&m&&!(C<X||ja)){var c,a,h,d,b,e,g,f,l,j=D-r.x,n=E-r.y,q=ta.getMaxHeight(),w=[ka+j,la+n],y,u,s,t,p,B;m.sort(function(c,a){return k(a[qa],w)/a[F]-k(c[qa],w)/c[F]});c=0;for(a=m.length;c<a;c++)if(b=m[c],!(b[F]<=q)){u=!1;e=b[G];y=[];h=0;for(d=e.length-1;h<d;h+=2)y[h]=f=e[h]-j,y[h+1]=l=e[h+1]-n,u||(u=0<f&&f<A&&0<l&&l<z);if(u){h=b[T]?b[F]*O:b[F];e=Y/(Y-h);b[x]&&
(h=b[T]?b[x]*O:b[x],g=Y/(Y-h));f=[];h=0;for(d=y.length-3;h<d;h+=2)l=y[h],s=y[h+1],u=y[h+2],t=y[h+3],p=na(l,s,e),B=na(u,t,e),b[x]&&(s=na(l,s,g),t=na(u,t,g),l=s.x,s=s.y,u=t.x,t=t.y),(u-l)*(p.y-s)>(p.x-l)*(t-s)&&(K.fillStyle=l<u&&s<t||l>u&&s>t?b[N][1]||ha:b[N][0]||S,W([u,t,l,s,p.x,p.y,B.x,B.y])),f[h]=p.x,f[h+1]=p.y;K.fillStyle=b[N][2]||ia;K.strokeStyle=b[N][1]||ha;W(f,!0)}}}}function W(c,a){if(c.length){K.beginPath();K.moveTo(c[0],c[1]);for(var b=2,d=c.length;b<d;b+=2)K.lineTo(c[b],c[b+1]);K.closePath();
a&&K.stroke();K.fill()}}function na(c,a,b){return{x:(c-ka)*b+ka<<0,y:(a-la)*b+la<<0}}var A=0,z=0,V=0,oa=0,D=0,E=0,C,ea,ra,K,R,Q=new q(200,190,180),sa=Q.adjustLightness(0.8),U=Q.adjustLightness(1.2),S=Q+"",ha=sa+"",ia=U+"",ga,r,m,O=1,za,M=1,X=xa,ya=20,fa,ka,la,Y,ja,Z={container:null,items:[],init:function(c){var a=this.container=pa.createElement("DIV");a.style.pointerEvents="none";a.style.position="absolute";a.style.left=0;a.style.top=0;ua.init(this.add());ta.init(this.add());K=this.add();c.appendChild(a);
return a},add:function(){var c=pa.createElement("CANVAS");c.style.webkitTransform="translate3d(0,0,0)";c.style.imageRendering="optimizeSpeed";c.style.position="absolute";c.style.left=0;c.style.top=0;var a=c.getContext("2d");a.lineCap="round";a.lineJoin="round";a.lineWidth=1;try{a.mozImageSmoothingEnabled=!1}catch(b){}this.items.push(c);this.container.appendChild(c);return a},setSize:function(c,a){for(var b=this.items,d=0,e=b.length;d<e;d++)b[d].width=c,b[d].height=a}},ua={context:null,color:new q(0,
0,0),colorStr:this.color+"",date:null,alpha:1,length:0,directionX:0,directionY:0,init:function(c){this.context=c;this.setDate((new Date).setHours(10))},render:function(){var c=this.context,a,h,d,e;c.clearRect(0,0,A,z);if(r&&m&&!(C<X||ja))if(a=b(D+V,E+oa),a=Ea(this.date,a.latitude,a.longitude),!(0>=a.altitude)){h=1/va(a.altitude);d=0.4/h;this.directionX=Ma(a.azimuth)*h;this.directionY=La(a.azimuth)*h;this.color.a=d;e=this.color+"";var f,g,j,l,k,n=D-r.x,q=E-r.y,p,y,u,s,t,w,B=[];c.beginPath();a=0;for(h=
m.length;a<h;a++){g=m[a];y=!1;j=g[G];p=[];d=0;for(f=j.length-1;d<f;d+=2)p[d]=l=j[d]-n,p[d+1]=k=j[d+1]-q,y||(y=0<l&&l<A&&0<k&&k<z);if(y){j=g[T]?g[F]*O:g[F];g[x]&&(j=g[T]?g[x]*O:g[x]);l=null;d=0;for(f=p.length-3;d<f;d+=2)k=p[d],u=p[d+1],y=p[d+2],s=p[d+3],t=this.project(k,u,j),w=this.project(y,s,j),g[x]&&(u=this.project(k,u,j),s=this.project(y,s,j),k=u.x,u=u.y,y=s.x,s=s.y),(y-k)*(t.y-u)>(t.x-k)*(s-u)?(1===l&&c.lineTo(k,u),l=0,d||c.moveTo(k,u),c.lineTo(y,s)):(0===l&&c.lineTo(t.x,t.y),l=1,d||c.moveTo(t.x,
t.y),c.lineTo(w.x,w.y));c.closePath();B.push(p)}}c.fillStyle=e;c.fill();c.globalCompositeOperation="destination-out";c.beginPath();a=0;for(h=B.length;a<h;a++){e=B[a];c.moveTo(e[0],e[1]);d=2;for(f=e.length;d<f;d+=2)c.lineTo(e[d],e[d+1]);c.lineTo(e[0],e[1]);c.closePath()}c.fillStyle="#00ff00";c.fill();c.globalCompositeOperation="source-over"}},project:function(a,b,e){return{x:a+this.directionX*e,y:b+this.directionY*e}},setDate:function(a){this.date=a;this.render()}},ta={context:null,maxHeight:8,init:function(a){this.context=
a},render:function(){var a=this.context;a.clearRect(0,0,A,z);if(r&&m&&!(C<X||ja)){var b,e,d,g,f,j,k,l=D-r.x,p=E-r.y,n,q;a.beginPath();b=0;for(e=m.length;b<e;b++){d=m[b];q=!1;f=d[G];n=[];d=0;for(g=f.length-1;d<g;d+=2)n[d]=j=f[d]-l,n[d+1]=k=f[d+1]-p,q||(q=0<j&&j<A&&0<k&&k<z);if(q){d=0;for(g=n.length-3;d<g;d+=2)q=n[d],f=n[d+1],d?a.lineTo(q,f):a.moveTo(q,f);a.closePath()}}a.fillStyle=ia;a.strokeStyle=ha;a.stroke();a.fill()}},getMaxHeight:function(){return this.maxHeight}};this.setStyle=function(a){a=
a||{};if(a.color||a.wallColor)Q=q.parse(a.color||a.wallColor),S=Q.adjustAlpha(M)+"",sa=Q.adjustLightness(0.8),ha=sa.adjustAlpha(M)+"",U=Q.adjustLightness(1.2),ia=U.adjustAlpha(M)+"";a.roofColor&&(U=q.parse(a.roofColor),ia=U.adjustAlpha(M)+"");I();return this};this.geoJSON=function(c,b){if("object"===typeof c)w(c,!b);else{var e=pa.documentElement,d=pa.createElement("script");a.jsonpCallback=function(c){delete a.jsonpCallback;e.removeChild(d);w(c,!b)};e.insertBefore(d,e.lastChild).src=c.replace(/\{callback\}/,
"jsonpCallback")}return this};this.setCamOffset=function(a,b){ka=V+a;la=z+b};this.setMaxZoom=function(a){ya=a};this.setDate=function(a){ua.setDate(a);return this};this.appendTo=function(a){return Z.init(a)};this.loadData=g;this.onMoveEnd=function(){var a=b(D,E),e=b(D+A,E+z);I();r&&(a[ca]>r.n||a[da]<r.w||e[ca]<r.s||e[da]>r.e)&&g()};this.onZoomEnd=function(a){ja=!1;J(a.zoom);ga?(m=j(ga),I()):($(),g())};this.onZoomStart=function(){ja=!0;I()};this.setOrigin=function(a,b){D=a;E=b};this.setSize=function(a,
b){A=a;z=b;V=A/2<<0;oa=z/2<<0;ka=V;la=z;Y=A/1.5/va(45)<<0;Z.setSize(A,z);fa=Y-50};this.setZoom=J;this.render=$;R=e};a.OSMBuildings.VERSION="0.1.8a";a.OSMBuildings.ATTRIBUTION='&copy; <a href="http://osmbuildings.org">OSM Buildings</a>'})(this);
L.BuildingsLayer=L.Class.extend({map:null,osmb:null,container:null,blockMoveEvent:null,lastX:0,lastY:0,initialize:function(a){L.Util.setOptions(this,a)},onMove:function(){var a=L.DomUtil.getPosition(this.map._mapPane);this.osmb.setCamOffset(this.lastX-a.x,this.lastY-a.y);this.osmb.render()},onMoveEnd:function(){if(this.blockMoveEvent)this.blockMoveEvent=!1;else{var a=L.DomUtil.getPosition(this.map._mapPane),k=this.map.getPixelOrigin();this.lastX=a.x;this.lastY=a.y;this.container.style.left=-a.x+"px";
this.container.style.top=-a.y+"px";this.osmb.setCamOffset(0,0);this.osmb.setSize(this.map._size.x,this.map._size.y);this.osmb.setOrigin(k.x-a.x,k.y-a.y);this.osmb.onMoveEnd()}},onZoomStart:function(){this.osmb.onZoomStart()},onZoomEnd:function(){var a=L.DomUtil.getPosition(this.map._mapPane),k=this.map.getPixelOrigin();this.osmb.setOrigin(k.x-a.x,k.y-a.y);this.osmb.onZoomEnd({zoom:this.map._zoom});this.blockMoveEvent=!0},addTo:function(a){a.addLayer(this);return this},onAdd:function(a){this.map=a;
a=this.map._panes.overlayPane;this.osmb?a.appendChild(this.container):(this.osmb=new OSMBuildings(this.options.url),this.container=this.osmb.appendTo(a),this.osmb.maxZoom=this.map._layersMaxZoom);a=L.DomUtil.getPosition(this.map._mapPane);var k=this.map.getPixelOrigin();this.osmb.setSize(this.map._size.x,this.map._size.y);this.osmb.setOrigin(k.x-a.x,k.y-a.y);this.osmb.setZoom(this.map._zoom);this.container.style.left=-a.x+"px";this.container.style.top=-a.y+"px";this.map.on({move:this.onMove,moveend:this.onMoveEnd,
zoomstart:this.onZoomStart,zoomend:this.onZoomEnd},this);this.map.attributionControl.addAttribution(OSMBuildings.ATTRIBUTION);this.osmb.loadData();this.osmb.render()},onRemove:function(a){a.attributionControl.removeAttribution(OSMBuildings.ATTRIBUTION);a.off({move:this.onMove,moveend:this.onMoveEnd,zoomstart:this.onZoomStart,zoomend:this.onZoomEnd},this);this.container.parentNode.removeChild(this.container)},geoJSON:function(a,k){return this.osmb.geoJSON(a,k)},setStyle:function(a){return this.osmb.setStyle(a)},
setDate:function(a){return this.osmb.setDate(a)}});
